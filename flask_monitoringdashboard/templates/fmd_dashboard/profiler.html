{% extends "fmd_dashboard/graph-details.html" %}

{% macro request_title(request) -%}
    {# request is a Request-object #}
    <div class="card-header">
        <h6>Request {{ "{}: {:%Y-%m-%d %H:%M:%S }".format(request.id, request.time_requested) }}</h6>
    </div>
{%- endmacro %}

{% macro compute_color(percentage) -%}
    {% set red = 230, 74, 54 %}
{#    {% set green = 205, 220, 57 %}#}
    {% set green = 198, 220, 0 %}

    {% set color_0 = red[0] * percentage + green[0] * (1 - percentage) %}
    {% set color_1 = red[1] * percentage + green[1] * (1 - percentage) %}
    {% set color_2 = red[2] * percentage + green[2] * (1 - percentage) %}
    {{ 'rgb({},{},{})'.format(color_0, color_1, color_2) }}
{%- endmacro %}

{% block graph_content %}
    {% macro table_row(request, index) -%}
        {% set line = request.stack_lines[index] %}
        {% set sum = request.stack_lines[0].duration %}
        {% set percentage = line.duration / sum if sum > 0 else 1 %}

        <tr>
            <td style="padding-left: {{ 10 + 15 * line.indent }}px;"><hide>{{ line.position }}</hide>
                {{ line.code.code }}
                {% if body[request.id][index] %}
                    <i class="fa fa-minus-square" style="cursor: pointer;"
                       onclick="toggle_rows( {{'{}, {}, this'.format(body[request.id][index], request.id) }})"></i>
                {% endif %}
            </td>
            <td style="text-align: right;"><time>{{ line.duration }}</time></td>
            <td style="text-align: right; background-color: {{ compute_color(percentage) }};">
                {{ "{:.1f} %".format(percentage * 100) }}
            </td>
        </tr>
    {%- endmacro %}


    {% if pagination %}
        {{ pagination.info }}
        {{ pagination.links }}
    {% endif %}
    {% for request in requests %}
        <div class="card">
            <div class="card">
                {{ request_title(request) }}
                <div class="card-body table-responsive">
                    <table class="table table-bordered req-id{{ request.id }}" id="dataTable" width="100%" cellspacing="0" >
                        <thead>
                            <tr>
                                <th style="width: 80%">Code-line</th>
                                <th style="width: 10%;">Duration</th>
                                <th style="width: 10%;">Percentage</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for index in range(request.stack_lines|length) %}
                                {{ table_row(request, index) }}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div><br/>

    {% endfor %}
    {% if pagination %}
        {{ pagination.info }}
        {{ pagination.links }}
    {% endif %}
{% endblock %}

{% block script %}
    <script type="text/javascript">
        $('#loading').hide();
        $('#dataTable').DataTable({
            "paging": false,
            "info": false,
            "searching": false
        });
        function toggle_rows(rows, request_id, icon){
            var table = $(".table.table-bordered.req-id" + request_id);

            if (icon.className.indexOf("fa-minus-square") >= 0){
                $(icon).removeClass("fa-minus-square");
                $(icon).addClass("fa-plus-square");

                rows.forEach(function(i){
                    var element = table.find('tr:eq(' + (i + 1) + ')');
                    element.find('.fa').removeClass("fa-plus-square").addClass("fa-minus-square");
                    if (element.is(":visible")){
                        element.hide();
                    }
                });
            } else {
                $(icon).removeClass("fa-plus-square");
                $(icon).addClass("fa-minus-square");

                rows.forEach(function(i){
                    var element = table.find('tr:eq(' + (i + 1) + ')');
                    if (!element.is(":visible")){
                        element.show();
                    }
                });
            }
        }
    </script>
{% endblock %}