{% extends "fmd_base.html" %}
{% set title="Testmonitor" %}
{% block content %}

    <div class="card mb-3">
        <div class="card-header"><h4>Testmonitor Overview</h4></div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered" id="dataTable" width="100%" cellspacing="0"
                       data-page-length="10">
                    <thead>
                    <tr>
                        <th colspan="2"></th>
                        <th colspan="2" style="text-align: center;">Number of times tested</th>
                        <th colspan="2" style="text-align: center;">Median execution time (ms)</th>
                        <th></th>
                    </tr>
                    <tr>
                        <th></th>
                        <th>Endpoint</th>
                        <th>Latest version</th>
                        <th>Overall</th>
                        <th>Latest version</th>
                        <th>Overall</th>
                        <th>Last tested</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for record in result %}
                        <tr style="cursor: pointer"
                            onclick="window.location='{{ url_for('dashboard.endpoint_test_details', end=record.name) }}';">
                            <td style="background-color: {{ record.color }}"></td>
                            <td style="max-width: 200px;">{{ record.name }}</td>
                            <td style="text-align: right;">{{ "{:,d}".format(record['tests-latest-version']) }}</td>
                            <td style="text-align: right;">{{ "{:,d}".format(record['tests-overall']) }}</td>
                            <td style="text-align: right;">{{ "{:,.1f}".format(record['median-latest-version']) }}</td>
                            <td style="text-align: right;">{{ "{:,.1f}".format(record['median-overall']) }}</td>
                            <td style="text-align: center;">{{ "{:%Y-%m-%d %H:%M:%S }".format(record['last-tested']) }}</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>



    <div class="card mb-3">
        <div class="card-header"><h4>Grouped Test Results</h4></div>
        <div class="card-body">
            {% for group in groups %}
                <div class="panel panel-default">
                    <div class="panel-heading" style="background-color: {{ colors[group] }}">
                        <h4 class="panel-title">
                            <a data-toggle="collapse" data-parent="#accordion"
                               href="{{ "#" + group|replace(".", "-") }}"
                               class="collapsed" style="background-color: #ffffff">&#9654; {{ group }}</a>
                        </h4>
                    </div>
                    <div id="{{ group|replace(".", "-") }}" class="panel-collapse collapse" style="height: auto;">
                        <div class="panel-body">

                            <div class="table-responsive">
                                <table class="table table-bordered">
                                    <tr>
                                        <th>Name: <i>functionName (fileName.className)</i></th>
                                        <th>Run .. times</th>
                                        <th>Average run time (ms)</th>
                                        <th>Run .. times [current version]</th>
                                        <th>Average run time [current version] (ms)</th>
                                        <th>Last run</th>
                                    </tr>
                                    {% for test in tests %}
                                        {% if test.name in groups[group] %}
                                            <tr>
                                                <td>
                                                    {#                                                    <a href="{{ url_for('dashboard.test_result', test=test.name) }}">{{ test.name }}</a>#}
                                                </td>
                                                {% if results[0] %}
                                                    {% for result in results %}
                                                        {% if result.name == test.name %}
                                                            <td style="text-align: right;">{{ result.count if result.count else "" }}</td>
                                                            <td style="text-align: right;">{{ ((result.average*10)|round)/10 if result.average else "" }}</td>
                                                        {% endif %}
                                                    {% endfor %}
                                                {% else %}
                                                    <td></td>
                                                    <td></td>
                                                {% endif %}

                                                {% if res_current_version[0] %}
                                                    {% for res in res_current_version %}
                                                        {% if res.name == test.name %}
                                                            <td style="text-align: right;">{{ res.count if res.count else "" }}</td>
                                                            <td style="text-align: right;">{{ ((res.average*10)|round)/10 if res.average else "" }}</td>
                                                        {% endif %}
                                                    {% endfor %}
                                                {% else %}
                                                    <td></td>
                                                    <td></td>
                                                {% endif %}
                                                {#                                                <td style="text-align: center;">#}
                                                {#                                                    {{ "{:%Y-%m-%d %H:%M:%S }".format(test.lastRun) if test.lastRun != None else "" }}#}
                                                {#                                                </td>#}
                                            </tr>
                                        {% endif %}
                                    {% endfor %}
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>

    <div class="card mb-3">
        <div class="card-header"><h4>Overall execution time</h4></div>
        <div class="card-body">

            <div id="loading">
                <div class="col-md-12 col-sm-12">
                    <br>
                    <div class="text-center">
                        <img src="{{ url_for('dashboard.static', filename='loading.gif') }}"
                             alt="Be patient..." align="center"/>
                    </div>
                </div>
            </div>

            {% if boxplot %}
                <div class="col-md-12 col-sm-12">
                    {{ boxplot|safe }}
                </div>
            {% else %}
                <p>No data available.</p>
            {% endif %}
        </div>
    </div>
{% endblock %}

{% block script %}
    <script>
        $(window).ready(function () {
            $('#loading').hide();
        });
    </script>
    <script type="text/javascript">
        $('#dataTable').DataTable().order([[4, "desc"]]).draw();
    </script>
{% endblock %}